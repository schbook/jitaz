var HiDPICanvas=function(){function t(){}return t.getPixelRatio=function(){var t=document.createElement("canvas").getContext("2d"),i=window.devicePixelRatio||1,e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return i/e},t.createHiDPICanvas=function(t,i,e){e||(e=this.getPixelRatio());var o=document.createElement("canvas");return o.width=t*e,o.height=i*e,o.style.width=t+"px",o.style.height=i+"px",o.getContext("2d").setTransform(e,0,0,e,0,0),o},t}(),Jitaz=function(){function t(t,i){this.mContainer=t,this.mConfig=this.initConfig(i),this.mCanvas=HiDPICanvas.createHiDPICanvas(this.mConfig.mWidth,this.mConfig.mHeight),document.getElementById(t).appendChild(this.mCanvas),this.mRender=new JitazRender(this.mCanvas,this.mConfig)}return t.prototype.render=function(t){return void 0===t?void console.error("the method of render cannot accept null parameter"):void this.mRender.render(t)},t.prototype.initConfig=function(t){void 0===t&&(t={});var i=void 0===t.mWidth?960:t.mWidth,e=void 0===t.mTab_line_width?850:t.mTab_line_width;return{mWidth:i,mHeight:void 0===t.mHeight?600:t.mHeight,mTab_line_width:e,mTab_line_space:void 0===t.mTab_line_space?11:t.mTab_line_space,mTab_row_height:void 0===t.mTab_row_height?160:t.mTab_row_height,mTab_col_width:void 0===t.mTab_col_width?e/4:t.mTab_col_width,mDraw_pos_x0:void 0===t.mDraw_pos_x0?(i-e)/2:t.mDraw_pos_x0,mDraw_pos_y0:void 0===t.mDraw_pos_y0?48:t.mDraw_pos_y0,mTab_font_family:void 0===t.mTab_font_family?"Times":t.mTab_font_family,mTab_base_font_size:void 0===t.mTab_base_font_size?12:t.mTab_base_font_size}},t}(),JitazRender=function(){function t(t,i){this.mConfig=i,this.mContext=t.getContext("2d")}return t.prototype.render=function(t){this.drawBkg(t.measures.length),this.drawHeader(t.header);for(var i=0;i<t.measures.length;i++)this.drawMeasureContent(t.header,t.measures[i],i)},t.prototype.drawBkg=function(t){this.mContext.save(),this.mContext.beginPath(),this.mContext.fillStyle="#ffffff",this.mContext.lineCap="rect",this.mContext.lineWidth=1,this.mContext.strokeStyle="#d5d5d5";var i=Math.ceil((t+1)/4),e=this.mConfig.mDraw_pos_y0,o=this.mConfig.mDraw_pos_x0,n=this.mConfig.mTab_line_space,s=this.mConfig.mTab_line_width,m=this.mConfig.mTab_row_height;this.mContext.fillRect(0,0,this.mConfig.mTab_line_width,i*this.mConfig.mTab_row_height);for(var a=0;a<i;a++){this.mContext.moveTo(o,e),this.mContext.lineTo(o,e+5*n);for(var h=0;h<6;h++)this.mContext.moveTo(o,e+h*n),this.mContext.lineTo(o+s,e+h*n);this.mContext.moveTo(o+s,e),this.mContext.lineTo(o+s,e+5*n),e+=m}this.mContext.stroke(),this.mContext.restore()},t.prototype.drawHeader=function(t){this.mContext.save(),this.mContext.fillStyle="#ffffff";var i=this.mConfig.mDraw_pos_x0,e=this.mConfig.mDraw_pos_y0,o=this.mConfig.mTab_line_space;this.mContext.fillRect(i-1,e-this.mConfig.mTab_base_font_size/2-1,this.mConfig.mTab_col_width/2,5*o+this.mConfig.mTab_base_font_size),this.mContext.fillStyle="#858585",this.mContext.font=this.mConfig.mTab_base_font_size+"px "+this.mConfig.mTab_font_family,this.mContext.textBaseline="top";for(var n=i+this.mConfig.mTab_col_width/2-this.mConfig.mTab_base_font_size,e=e-this.mConfig.mTab_base_font_size/2-1,s=0;s<t.tunes.length;s++)this.mContext.fillText(t.tunes[s],n,e+s*o);var m=2*this.mConfig.mTab_base_font_size;this.mContext.fillStyle="#000000",this.mContext.font="bold "+m+"px "+this.mConfig.mTab_font_family,this.mContext.textBaseline="top";var a=(5*o-2*m)/2;this.mContext.fillText(t.time.beats.toString(),n+2*this.mConfig.mTab_base_font_size,this.mConfig.mDraw_pos_y0+a-2),this.mContext.fillText(t.time.type.toString(),n+2*this.mConfig.mTab_base_font_size,this.mConfig.mDraw_pos_y0+a+m),this.mContext.restore()},t.prototype.drawMeasureContent=function(t,i,e){this.mContext.save(),e+=1;var o=this.mConfig.mTab_col_width,n=this.mConfig.mTab_row_height,s=this.mConfig.mTab_line_space,m=this.mConfig.mDraw_pos_x0+e%4*o+this.mConfig.mTab_base_font_size,a=this.mConfig.mDraw_pos_y0+Math.floor(e/4)*n,h=i.measure,r=[],f="bold "+this.mConfig.mTab_base_font_size+"px "+this.mConfig.mTab_font_family;this.mContext.beginPath(),this.mContext.lineCap="rect",this.mContext.lineWidth=1,this.mContext.strokeStyle="#000000",this.mContext.font=f;for(var _=.7*this.mContext.measureText("0").width,C=0,x=(o-2*this.mConfig.mTab_base_font_size)/t.time.beats,l=0,b=m,g=0;g<h.length;g++){var d=h[g].keys;b+=C;for(var T={x:b,y:0},v=0;v<d.length;v++){var p=d[v],c=a-this.mConfig.mTab_base_font_size/2-1+(p.str-1)*s;this.drawText(p.fret.toString(),f,b,c,!0),T.y<c&&(T.y=c)}if(r.push(T),this.mContext.moveTo(b+_,a+6*s),this.mContext.lineTo(b+_,a+8*s),C=t.time.type/h[g].duration*x,l+=t.time.type/h[g].duration,l!=Math.floor(l))for(var w=0;w<1/C;w++)this.mContext.lineTo(b+_,a+8*s-w*this.mConfig.mTab_base_font_size/2),this.mContext.lineTo(b+_+C,a+8*s-w*this.mConfig.mTab_base_font_size/2),this.mContext.lineTo(b+_,a+8*s-w*this.mConfig.mTab_base_font_size/2-1),this.mContext.lineTo(b+_+C,a+8*s-w*this.mConfig.mTab_base_font_size/2-1),this.mContext.lineTo(b+_,a+8*s-w*this.mConfig.mTab_base_font_size/2-2),this.mContext.lineTo(b+_+C,a+8*s-w*this.mConfig.mTab_base_font_size/2-2)}this.mContext.stroke(),this.mContext.restore(),i.relations&&this.drawRelation(i.relations,r)},t.prototype.drawText=function(t,i,e,o,n){if(this.mContext.save(),this.mContext.font=i,this.mContext.textBaseline="top",n){this.mContext.fillStyle="#ffffff";var s=1.4*this.mContext.measureText(t).width;this.mContext.fillRect(e-.2*s,o,s,parseInt(i,10))}this.mContext.fillStyle="#000",this.mContext.fillText(t,e,o),this.mContext.restore()},t.prototype.drawRelation=function(t,i){this.mContext.save(),this.mContext.font="bold "+this.mConfig.mTab_base_font_size+"px "+this.mConfig.mTab_font_family,this.mContext.fillStyle="#000000";for(var e=0;e<t.length;e++){var o=t[e];this.drawCurve(i[o.start],i[o.end])}this.mContext.restore()},t.prototype.drawCurve=function(t,i,e){console.log(t.x-i.x,t,i),void 0===e&&(e=1);var o=.5*this.mContext.measureText("0").width;t.x=t.x+o,i.x=i.x+o;var n=this.mConfig.mTab_line_space/2,s=Math.abs(t.x-i.x)/4;this.mContext.beginPath(),this.mContext.moveTo(t.x,t.y),this.mContext.bezierCurveTo(t.x+n,t.y-s*e,i.x-n,i.y-s*e,i.x,i.y),this.mContext.bezierCurveTo(i.x-n,i.y-(s+2)*e,t.x+n,t.y-(s+2)*e,t.x,t.y),this.mContext.stroke(),this.mContext.closePath(),this.mContext.fill()},t}();